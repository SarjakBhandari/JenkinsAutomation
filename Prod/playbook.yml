---
- name: Deploy Healthify Stack to Docker Swarm
  hosts: swarm_manager
  become: false
  vars:
    registry_ip: "192.168.50.4"
    version: "latest"

  tasks:

    - name: Validate registry_ip and version
      fail:
        msg: "Missing registry_ip or version. Cannot deploy services."
      when: registry_ip | length == 0 or version | length == 0

    - name: Ensure node is a Swarm manager
      command: docker info --format="{{ '{{.Swarm.ControlAvailable}}' }}"
      register: is_manager
      changed_when: false

    - name: Fail if not a manager
      fail:
        msg: "This node is not a Swarm manager. Cannot create overlay network or deploy services."
      when: is_manager.stdout != "true"

    - name: Create overlay network if not exists
      shell: |
        docker network inspect healthify_net >/dev/null 2>&1 || \
        docker network create --driver overlay --attachable healthify_net
      args:
        warn: false
      register: overlay_net_result
      changed_when: "'Created' in overlay_net_result.stdout"

    - name: Check if backend service exists
      shell: docker service inspect healthify_backend
      register: backend_check
      ignore_errors: true
      changed_when: false

    - name: Deploy backend service if not exists
      shell: |
        docker service create \
          --name healthify_backend \
          --network healthify_net \
          --replicas 1 \
          --env DB_USER=postgres \
          --env DB_PASSWORD=postgres \
          --env DB_NAME=healthify \
          --env PORT=5000 \
          --publish published=5000,target=5000 \
          {{ registry_ip }}/healthify-backend:{{ version }}
      when: backend_check.rc != 0
      register: backend_result
      changed_when: true

    - name: Check if frontend service exists
      shell: docker service inspect healthify_frontend
      register: frontend_check
      ignore_errors: true
      changed_when: false

    - name: Deploy frontend service if not exists
      shell: |
        docker service create \
          --name healthify_frontend \
          --network healthify_net \
          --replicas 1 \
          --env PORT=5173 \
          --publish published=5173,target=5173 \
          {{ registry_ip }}/healthify-frontend:{{ version }}
      when: frontend_check.rc != 0
      register: frontend_result
      changed_when: true
