---
- name: Deploy Healthify Stack to Docker Swarm
  hosts: all
  become: false
  vars:
    registry_ip: ""
    version: ""

  tasks:

    - name: Create overlay network if not exists
      shell: |
        docker network inspect healthify_net >/dev/null 2>&1 || \
        docker network create --driver overlay --attachable healthify_net
      args:
        warn: false

    - name: Deploy backend service
      shell: |
        docker service create \
          --name healthify_backend \
          --network healthify_net \
          --replicas 1 \
          --env DB_USER=postgres \
          --env DB_PASSWORD=postgres \
          --env DB_NAME=healthify \
          --env PORT=5000 \
          --publish published=5000,target=5000 \
          ${registry_ip}/healthify-backend:${version}
      args:
        warn: false

    - name: Deploy frontend service
      shell: |
        docker service create \
          --name healthify_frontend \
          --network healthify_net \
          --replicas 1 \
          --env PORT=5173 \
          --publish published=5173,target=5173 \
          ${registry_ip}/healthify-frontend:${version}
      args:
        warn: false
