- name: Deploy Healthify stack to Docker Swarm
  hosts: swarm_managers
  become: true
  vars:
    overlay_network: healthify_net
    registry_ip: 192.168.50.4
    version: "v1.2.3"
    env_file: "/opt/healthify/.env"
    backend_port: "5050"
    frontend_port: "5173"
    backend_host: "backend"

  tasks:

    - name: Ensure overlay network exists
      command: docker network create --driver overlay {{ overlay_network }}
      register: network_create
      failed_when: network_create.rc != 0 and 'already exists' not in network_create.stderr
      changed_when: "'already exists' not in network_create.stderr"

    - name: Template Docker stack file
      template:
        src: ./files/docker-stack.yml.j2
        dest: /tmp/docker-stack.yml
        mode: '0644'

    - name: Deploy Docker stack
      command: docker stack deploy -c /tmp/docker-stack.yml healthify
      args:
        warn: false
