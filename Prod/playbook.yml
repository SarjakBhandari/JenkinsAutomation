---
- name: Deploy healthify fullstack app with load balancing (CLI only)
  hosts: swarm_manager
  become: yes

  # Safe defaults — CLI `--extra-vars` still override these
  vars:
    stack_name: healthify
    registry_ip: 192.168.50.4
    version: latest
    overlay_network: healthify_net
    stack_file: "/home/{{ ansible_user }}/docker-stack.yml"
    env_file: "/home/{{ ansible_user }}/.env"
    backend_port: 5000
    frontend_port: 5173

  tasks:

    - name: Show resolved overlay_network value
      ansible.builtin.debug:
        msg: "Overlay network = {{ overlay_network }}"

    - name: Upload .env file to manager node
      ansible.builtin.copy:
        src: ../.env
        dest: "{{ env_file }}"
        mode: '0644'

    - name: Render docker-stack.yml from template
      ansible.builtin.template:
        src: files/docker-stack.yml.j2
        dest: "{{ stack_file }}"
        mode: '0644'

    - name: Fail if vars are missing
      ansible.builtin.fail:
        msg: "registry_ip='{{ registry_ip | default('') }}', version='{{ version | default('') }}' → Cannot pre-pull images."
      when: registry_ip | trim | length == 0 or version | trim | length == 0
    
    - name: Pre-pull images from registry
      ansible.builtin.shell: >
        docker pull {{ registry_ip }}:5000/healthify-backend:{{ version }}
        && docker pull {{ registry_ip }}:5000/healthify-frontend:{{ version }}
      args:
        warn: false
      when:
        - registry_ip | trim | length > 0
        - version | trim | length > 0
      changed_when: false



    - name: Deploy or update Docker stack
      ansible.builtin.shell: >
        docker stack deploy --with-registry-auth -c {{ stack_file }} {{ stack_name }}
      changed_when: false

    - name: Wait for services to start (initial delay)
      ansible.builtin.pause:
        seconds: 5

    - name: Check service replicas until healthy
      ansible.builtin.shell: |
        docker service ls --filter name={{ stack_name }} --format '{{ "{{.Name}}" }} {{ "{{.Replicas}}" }}' |
        awk '{split($2,a,"/"); if(a[1]!=a[2]) exit 1}'
      register: service_status
      retries: 12
      delay: 5
      until: service_status.rc == 0
      changed_when: false

    - name: Display deployed services
      ansible.builtin.debug:
        msg: "{{ service_status.stdout_lines }}"
