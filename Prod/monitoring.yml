---
- name: Deploy monitoring stack (Prometheus, Grafana, Blackbox)
  hosts: swarm_manager
  become: yes
  vars:
    monitor_dir: /home/jenkins/monitoring
    stack_file: "{{ monitor_dir }}/monitoring-stack.yml"
    prometheus_config: "{{ monitor_dir }}/prometheus.yml"
    alert_rules: "{{ monitor_dir }}/alert.rules.yml"
    grafana_data_dir: /var/lib/grafana
    overlay_network: monitoring_net

  tasks:
    - name: Ensure monitoring directory exists
      file:
        path: "{{ monitor_dir }}"
        state: directory
        owner: jenkins
        group: jenkins
        mode: '0755'
        recurse: yes
      tags: [monitoring]

    - name: Ensure overlay network exists
      community.docker.docker_network:
        name: "{{ overlay_network }}"
        driver: overlay
        attachable: true
        state: present
      tags: [monitoring]

    - name: Copy monitoring stack file
      copy:
        src: files/monitoring-stack.yml
        dest: "{{ stack_file }}"
        owner: jenkins
        group: jenkins
        mode: '0644'
      tags: [monitoring]

    - name: Copy Prometheus config
      copy:
        src: files/prometheus.yml
        dest: "{{ prometheus_config }}"
        owner: jenkins
        group: jenkins
        mode: '0644'
      tags: [monitoring]

    - name: Copy alert rules
      copy:
        src: files/alert.rules.yml
        dest: "{{ alert_rules }}"
        owner: jenkins
        group: jenkins
        mode: '0644'
      tags: [monitoring]

    - name: Ensure Grafana data directory exists
      file:
        path: "{{ grafana_data_dir }}"
        state: directory
        owner: 472
        group: 472
        mode: '0755'
      tags: [monitoring]

    - name: Check Docker is running
      community.docker.docker_host_info:
      register: docker_info
      failed_when: docker_info is failed
      tags: [monitoring]

    - name: Deploy monitoring stack
      community.docker.docker_stack:
        name: monitoring
        state: present
        compose:
          - "{{ stack_file }}"
        prune: yes
      tags: [monitoring]
